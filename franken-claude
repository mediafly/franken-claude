#!/bin/bash
set -e

# franken-claude: Launch Claude Code containers with AWS SSO credential injection
# Usage: franken-claude --profile <aws-profile> --repo <path-to-git-repo>

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
IMAGE_NAME="franken-claude"
BASE_PORT=7681

usage() {
    echo "Usage: franken-claude --profile <aws-profile> --repo <path-to-git-repo>"
    echo ""
    echo "Options:"
    echo "  --profile, -p    AWS SSO profile name (required)"
    echo "  --repo, -r       Path to git repository to mount (required)"
    echo "  --help, -h       Show this help message"
    echo ""
    echo "Example:"
    echo "  franken-claude --profile my-dev-account --repo ~/projects/my-app"
    exit 1
}

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

warn() {
    echo -e "${YELLOW}Warning: $1${NC}" >&2
}

info() {
    echo -e "${GREEN}$1${NC}"
}

# Parse arguments
AWS_PROFILE=""
REPO_PATH=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --profile|-p)
            AWS_PROFILE="$2"
            shift 2
            ;;
        --repo|-r)
            REPO_PATH="$2"
            shift 2
            ;;
        --help|-h)
            usage
            ;;
        *)
            error "Unknown option: $1"
            ;;
    esac
done

# Validate required arguments
if [ -z "$AWS_PROFILE" ]; then
    error "Missing required argument: --profile"
fi

if [ -z "$REPO_PATH" ]; then
    error "Missing required argument: --repo"
fi

# Resolve repo path to absolute path
REPO_PATH=$(cd "$REPO_PATH" 2>/dev/null && pwd) || error "Repository path does not exist: $REPO_PATH"

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    error "Docker is not installed or not in PATH"
fi

# Build image if it doesn't exist
if ! docker image inspect "$IMAGE_NAME" &> /dev/null; then
    info "Building franken-claude image (this may take a few minutes)..."
    docker build -t "$IMAGE_NAME" "$SCRIPT_DIR" || error "Failed to build Docker image"
fi

# Extract AWS credentials using aws configure export-credentials
info "Checking AWS credentials for profile: $AWS_PROFILE"

# Try to get credentials, if it fails, run SSO login
if ! CREDS_JSON=$(aws configure export-credentials --profile "$AWS_PROFILE" --format env-no-export 2>&1); then
    echo ""
    warn "AWS SSO credentials expired or not found"
    info "Launching SSO login for profile: $AWS_PROFILE"
    echo ""

    if ! aws sso login --profile "$AWS_PROFILE"; then
        error "SSO login failed"
    fi

    echo ""
    info "SSO login successful, extracting credentials..."

    CREDS_JSON=$(aws configure export-credentials --profile "$AWS_PROFILE" --format env-no-export 2>&1) || {
        error "Failed to extract credentials after SSO login"
    }
fi

# Parse credentials from env-no-export format
AWS_ACCESS_KEY_ID=$(echo "$CREDS_JSON" | grep "AWS_ACCESS_KEY_ID=" | cut -d'=' -f2)
AWS_SECRET_ACCESS_KEY=$(echo "$CREDS_JSON" | grep "AWS_SECRET_ACCESS_KEY=" | cut -d'=' -f2)
AWS_SESSION_TOKEN=$(echo "$CREDS_JSON" | grep "AWS_SESSION_TOKEN=" | cut -d'=' -f2)

if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
    error "Failed to extract AWS credentials"
fi

# Get region from profile
AWS_REGION=$(aws configure get region --profile "$AWS_PROFILE" 2>/dev/null || echo "us-east-1")

info "AWS credentials extracted successfully"
info "Region: $AWS_REGION"

# Find next available container number for this profile
CONTAINER_BASE="franken-${AWS_PROFILE}"
CONTAINER_NUM=1

while docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_BASE}-${CONTAINER_NUM}$"; do
    CONTAINER_NUM=$((CONTAINER_NUM + 1))
done

CONTAINER_NAME="${CONTAINER_BASE}-${CONTAINER_NUM}"

# Find next available port
PORT=$BASE_PORT
while lsof -i :$PORT &> /dev/null || docker ps --format '{{.Ports}}' | grep -q ":${PORT}->"; do
    PORT=$((PORT + 1))
done

info "Starting container: $CONTAINER_NAME"
info "Mounting repository: $REPO_PATH"
info "Web terminal will be available at: http://localhost:$PORT"

# Run the container
# Note: We do NOT set AWS_PROFILE inside the container because there's no
# ~/.aws/config file there. The AWS CLI will use the credential env vars directly.
docker run -d \
    --name "$CONTAINER_NAME" \
    -p "${PORT}:7681" \
    -v "${REPO_PATH}:/workspace" \
    -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" \
    -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" \
    -e "AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}" \
    -e "AWS_REGION=${AWS_REGION}" \
    -e "AWS_DEFAULT_REGION=${AWS_REGION}" \
    -e "CONTEXT7_API_KEY=${CONTEXT7_API_KEY:-}" \
    -e "ANTHROPIC_AUTH_TOKEN=${CLAUDE_OAUTH_TOKEN:-}" \
    "$IMAGE_NAME" || error "Failed to start container"

# Wait a moment for ttyd to start
sleep 2

# Check if container is still running
if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo ""
    echo -e "${RED}Container failed to start. Logs:${NC}"
    docker logs "$CONTAINER_NAME"
    docker rm "$CONTAINER_NAME" &> /dev/null
    exit 1
fi

info ""
info "=========================================="
info "  franken-claude is ready!"
info "=========================================="
info ""
info "Container: $CONTAINER_NAME"
info "Web terminal: http://localhost:$PORT"
info ""
info "Open additional terminal tabs at the same URL."
info "Each tab gets its own git worktree."
info ""
info "To stop: franken-claude-stop $CONTAINER_NAME"
info "         franken-claude-stop $AWS_PROFILE  (stops all)"
info ""

# Open browser
if command -v open &> /dev/null; then
    open "http://localhost:$PORT"
elif command -v xdg-open &> /dev/null; then
    xdg-open "http://localhost:$PORT"
fi
