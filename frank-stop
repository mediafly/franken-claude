#!/bin/bash
set -e

# frank-claude-stop: Stop and cleanup frank-claude containers
# Usage: frank-claude-stop <profile-or-container-name>
#        frank-claude-stop myprofile           # stops all containers for that profile
#        frank-claude-stop frank-myprofile-2 # stops specific container

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: frank-claude-stop <profile-or-container-name>"
    echo ""
    echo "Examples:"
    echo "  frank-claude-stop myprofile           # Stop all containers for 'myprofile'"
    echo "  frank-claude-stop frank-myprofile-2 # Stop specific container"
    echo ""
    echo "Options:"
    echo "  --all, -a    Stop all frank-claude containers"
    echo "  --help, -h   Show this help message"
    exit 1
}

error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}$1${NC}"
}

cleanup_container() {
    local container_name="$1"

    echo "Stopping: $container_name"

    # Cleanup git worktrees inside the container before stopping
    echo "  Cleaning up git worktrees..."
    docker exec "$container_name" bash -c '
        cd /workspace 2>/dev/null || exit 0
        if [ -d .git ]; then
            git worktree list --porcelain 2>/dev/null | grep "^worktree /worktrees" | cut -d" " -f2 | while read wt; do
                git worktree remove --force "$wt" 2>/dev/null || true
            done
        fi
        rm -rf /worktrees/* 2>/dev/null || true
    ' 2>/dev/null || true

    # Commit container state to a new image before stopping
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local saved_image="${container_name}:${timestamp}"
    echo "  Saving container state to image: $saved_image"
    docker commit "$container_name" "$saved_image" > /dev/null 2>&1 || warn "  Warning: Failed to save container state"

    # Stop and remove the container
    echo "  Stopping container..."
    docker stop "$container_name" > /dev/null 2>&1 || true

    echo "  Removing container..."
    docker rm "$container_name" > /dev/null 2>&1 || true

    info "  Done: $container_name"
    info "  Saved as: $saved_image"
}

# Parse arguments
if [ $# -eq 0 ]; then
    usage
fi

case $1 in
    --help|-h)
        usage
        ;;
    --all|-a)
        # Stop all frank-claude containers
        CONTAINERS=$(docker ps -a --format '{{.Names}}' | grep "^frank-" || true)
        if [ -z "$CONTAINERS" ]; then
            warn "No frank-claude containers found"
            exit 0
        fi

        echo "Stopping all frank-claude containers:"
        echo "$CONTAINERS" | while read container; do
            cleanup_container "$container"
        done

        info ""
        info "All frank-claude containers stopped and removed"
        ;;
    *)
        TARGET="$1"

        # Check if it's a full container name (starts with frank-)
        if [[ "$TARGET" == frank-* ]]; then
            # Specific container
            if ! docker ps -a --format '{{.Names}}' | grep -q "^${TARGET}$"; then
                error "Container not found: $TARGET"
            fi
            cleanup_container "$TARGET"
        else
            # Assume it's a profile name, stop all containers for that profile
            PROFILE_CONTAINERS=$(docker ps -a --format '{{.Names}}' | grep "^frank-${TARGET}-" || true)

            if [ -z "$PROFILE_CONTAINERS" ]; then
                error "No containers found for profile: $TARGET"
            fi

            echo "Stopping all containers for profile '$TARGET':"
            echo "$PROFILE_CONTAINERS" | while read container; do
                cleanup_container "$container"
            done

            info ""
            info "All containers for profile '$TARGET' stopped and removed"
        fi
        ;;
esac
